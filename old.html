<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ConnX Holiday Competition 2025</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            'comic': ['"Comic Sans MS"', '"Chalkboard SE"', 'sans-serif'],
          },
          animation: {
            'float-slow': 'float 6s ease-in-out infinite',
            'float-medium': 'float 4s ease-in-out infinite',
            'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'drive': 'drive 15s linear infinite',
            'wiggle': 'wiggle 1s ease-in-out infinite',
            'spin-slow': 'spin 8s linear infinite',
            'shimmer': 'shimmer 2s linear infinite',
          },
          keyframes: {
            float: {
              '0%,100%': { transform: 'translateY(0) rotate(0deg)' },
              '50%': { transform: 'translateY(-15px) rotate(5deg)' },
            },
            drive: {
              '0%': { transform: 'translateX(-100vw)' },
              '100%': { transform: 'translateX(100vw)' },
            },
            wiggle: {
              '0%, 100%': { transform: 'rotate(-1deg)' },
              '50%': { transform: 'rotate(1deg)' },
            },
            shimmer: {
              '0%': { backgroundPosition: '-200% 0' },
              '100%': { backgroundPosition: '200% 0' }
            }
          }
        }
      }
    }
  </script>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <!-- Canvas Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* Animated gradient background */
    .animated-bg {
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.6), transparent 50%),
        radial-gradient(circle at 80% 0%, rgba(255, 192, 203, 0.5), transparent 55%),
        radial-gradient(circle at 0% 80%, rgba(173, 216, 230, 0.5), transparent 55%),
        radial-gradient(circle at 90% 90%, rgba(144, 238, 144, 0.5), transparent 55%);
      background-color: #fff7e6;
      background-size: 200% 200%;
      animation: gradientShift 20s ease-in-out infinite;
      z-index: -20;
    }

    .dark .animated-bg {
      background:
        radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.1), transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(147, 197, 253, 0.15), transparent 55%),
        radial-gradient(circle at 0% 80%, rgba(167, 243, 208, 0.1), transparent 55%),
        radial-gradient(circle at 90% 90%, rgba(251, 191, 36, 0.1), transparent 55%);
      background-color: #0f172a;
    }

    @keyframes gradientShift {
      0% {
        background-position: 0% 0%;
      }

      50% {
        background-position: 100% 100%;
      }

      100% {
        background-position: 0% 0%;
      }
    }

    /* Snow / Confetti Canvas */
    canvas#snowCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -10;
    }

    /* Animated page transitions */
    .fade-enter-active,
    .fade-leave-active {
      transition: opacity .4s, transform .4s;
    }

    .fade-enter-from,
    .fade-leave-to {
      opacity: 0;
      transform: translateY(20px);
    }

    /* Floating emojis */
    .emoji-float {
      position: fixed;
      font-size: 2.5rem;
      z-index: -5;
      opacity: 0.6;
      pointer-events: none;
    }

    /* Chaos Mode Classes */
    .chaos-mode {
      font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif !important;
      transform: rotate(0.5deg);
    }

    .chaos-mode button:hover {
      transform: scale(0.9) rotate(-3deg) !important;
    }

    .chaos-mode h1,
    .chaos-mode h2 {
      letter-spacing: -2px;
      color: #ec4899;
    }

    /* Bus Animation Container */
    .bus-lane {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 60px;
      z-index: -2;
      overflow: hidden;
      pointer-events: none;
    }

    .bus {
      position: absolute;
      font-size: 3rem;
      bottom: 10px;
      left: -100px;
      /* Start off screen */
    }

    /* Podium Styles */
    .podium-container {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .podium-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      transition: transform 0.3s ease;
    }

    .podium-step:hover {
      transform: scale(1.05);
    }

    .podium-block {
      width: 100px;
      border-radius: 12px 12px 0 0;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 10px;
      color: white;
      font-weight: bold;
      font-size: 2rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    /* Podium Heights */
    .podium-1 .podium-block {
      height: 160px;
      background: linear-gradient(to top, #eab308, #facc15);
      border: 2px solid #fef08a;
    }

    /* Gold */
    .podium-2 .podium-block {
      height: 120px;
      background: linear-gradient(to top, #9ca3af, #d1d5db);
      border: 2px solid #e5e7eb;
    }

    /* Silver */
    .podium-3 .podium-block {
      height: 90px;
      background: linear-gradient(to top, #d97706, #fbbf24);
      border: 2px solid #fde68a;
    }

    /* Bronze */
  </style>
</head>

<body :class="{'chaos-mode': chaosMode}"
  class="min-h-screen text-gray-800 dark:text-gray-100 transition-all duration-500 overflow-x-hidden">

  <!-- Background layers -->
  <div class="animated-bg"></div>
  <canvas id="snowCanvas"></canvas>

  <!-- Background Floating Items -->
  <div class="emoji-float animate-float-slow left-4 top-20">üöç</div>
  <div class="emoji-float animate-float-medium right-6 top-40">üéÑ</div>
  <div class="emoji-float animate-float-slow left-10 bottom-32">üéüÔ∏è</div>
  <div class="emoji-float animate-float-medium right-10 bottom-24">‚òÉÔ∏è</div>
  <div class="emoji-float animate-spin-slow left-1/2 top-1/2 opacity-10 text-9xl">‚ùÑÔ∏è</div>

  <!-- Moving Bus Animation -->
  <div class="bus-lane">
    <div class="bus animate-drive">üöåüí® <span class="text-sm bg-white text-black p-1 rounded -ml-2">ConnX Express</span>
    </div>
  </div>

  <div id="app" class="relative z-10 min-h-screen flex flex-col">

    <!-- NAVBAR -->
    <nav
      class="bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 dark:from-indigo-900 dark:via-purple-900 dark:to-pink-900 p-3 shadow-2xl sticky top-0 z-50 backdrop-blur-md bg-opacity-90">
      <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-2">
        <h1 @click="setPage('home')"
          class="text-white text-xl md:text-2xl font-extrabold drop-shadow-lg cursor-pointer flex items-center gap-2 hover:scale-105 transition-transform">
          <span class="text-3xl">üéâ</span>
          <span>ConnX Holiday '25</span>
        </h1>

        <!-- Countdown Timer -->
        <div @dblclick="setPage('admin')"
          class="hidden lg:flex items-center gap-2 text-white bg-white/20 px-4 py-1 rounded-full text-xs font-mono border border-white/30 shadow-inner cursor-help select-none"
          title="Double click for secret admin access">
          <span>üèÜ Winners Revealed in:</span>
          <span class="font-bold text-yellow-300 text-sm">{{ countdownString }}</span>
        </div>

        <div class="flex items-center gap-3">
          <!-- Main Nav -->
          <ul class="hidden md:flex gap-4 text-white font-bold text-sm uppercase tracking-wide">
            <li><a href="#/home" :class="{'text-yellow-300 underline': currentPage === 'home'}"
                class="hover:text-yellow-200 transition-colors">Vote</a></li>
            
            <!-- Submit (Public) -->
            <li v-if="!competitionEnded"><a href="#/submit"
                :class="{'text-yellow-300 underline': currentPage === 'submit'}"
                class="hover:text-yellow-200 transition-colors">Submit</a></li>
            
            <!-- Dashboard (Admin Only) -->
            <li v-if="adminAuth"><a href="#/admin"
                :class="{'text-yellow-300 underline': currentPage === 'admin'}"
                class="hover:text-yellow-200 transition-colors">Dashboard</a></li>
          </ul>

          <!-- Mobile Nav -->
          <select
            class="md:hidden bg-white/20 text-white rounded-lg px-2 py-1 text-sm border-none outline-none focus:ring-2 focus:ring-yellow-300 cursor-pointer"
            @change="navigate($event)" :value="currentPage">
            <option class="text-black" value="home">Vote</option>
            <option v-if="!competitionEnded" class="text-black" value="submit">Submit</option>
            <option v-if="adminAuth" class="text-black" value="admin">Dashboard</option>
          </select>

          <!-- Chaos Toggle -->
          <button @click="toggleChaos"
            class="bg-red-500/80 hover:bg-red-600 text-white px-2 py-1 rounded-lg text-sm font-bold border-b-4 border-red-700 active:border-b-0 active:translate-y-1 transition-all"
            title="Toggle Chaos Mode">
            ü§™
          </button>

          <!-- Snow toggle -->
          <button @click="toggleSnow"
            class="bg-blue-400/50 hover:bg-blue-500/50 text-white px-2 py-1 rounded-lg text-lg transition-colors"
            :title="snowEnabled ? 'Stop the snow' : 'Let it snow'">
            {{ snowEnabled ? '‚ùÑÔ∏è' : 'üö´' }}
          </button>

          <!-- Dark Mode Toggle -->
          <button @click="toggleDark"
            class="bg-slate-800/50 text-white px-2 py-1 rounded-lg text-lg transition-colors hover:bg-slate-700/50">
            {{ isDark ? 'üåô' : '‚òÄÔ∏è' }}
          </button>
        </div>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="flex-1 container mx-auto p-4 sm:p-6 pb-20">

      <!-- Mobile Countdown (visible only on small screens) -->
      <div class="lg:hidden mb-6 text-center">
        <div class="inline-block bg-pink-600/90 text-white px-4 py-1 rounded-full text-xs font-bold shadow-lg">
          ‚è≥ Winners in: {{ countdownString }}
        </div>
      </div>

      <transition name="fade" mode="out-in">
        <div :key="currentPage">

          <!-- HOME / VOTING PAGE -->
          <section v-if="currentPage === 'home'">
            <div class="text-center mb-8 relative">
              <h2
                class="text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-600 to-purple-600 dark:from-pink-300 dark:to-blue-300 mb-2 drop-shadow-sm filter">
                "Bad UI" Showdown
              </h2>
              <p class="text-lg md:text-xl text-gray-700 dark:text-gray-300 max-w-2xl mx-auto leading-relaxed">
                Welcome to the ConnX Holiday Party! üöç <br>
                Vote for the most <span class="font-bold text-red-500">hilariously frustrating</span> "Rate Your Ride"
                widget.
              </p>

              <!-- Competition Ended Message -->
              <div v-if="competitionEnded"
                class="mt-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 max-w-2xl mx-auto rounded shadow-lg"
                role="alert">
                <p class="font-bold">üö´ Voting is Closed!</p>
              </div>

              <div class="absolute -top-4 -right-4 md:right-20 animate-bounce hidden md:block text-4xl">üëá</div>
            </div>

            <div v-if="websites.length === 0"
              class="text-center p-12 bg-white/50 dark:bg-black/20 rounded-3xl backdrop-blur-sm">
              <p class="text-2xl text-gray-500">No entries yet! Be the first to submit chaos. üòà</p>
              <button v-if="!competitionEnded" @click="setPage('submit')"
                class="mt-4 bg-blue-500 text-white px-6 py-2 rounded-full hover:bg-blue-600 transition">
                Submit Now
              </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div v-for="(site, i) in websites" :key="site.id"
                class="group relative bg-white/80 dark:bg-gray-900/80 backdrop-blur-md p-1 rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 hover:-translate-y-1 border-4 border-transparent hover:border-pink-300 dark:hover:border-purple-500">

                <div
                  class="p-5 rounded-[20px] bg-gradient-to-b from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 h-full flex flex-col">
                  <div class="flex justify-between items-start mb-3">
                    <div>
                      <h3 class="text-2xl font-bold text-gray-800 dark:text-white leading-tight">
                        {{ site.title }}
                      </h3>
                      <!-- Show External Link Icon only if it's a URL -->
                      <a v-if="site.type === 'url'" :href="site.url" target="_blank"
                        class="text-xs text-blue-500 hover:underline flex items-center gap-1">
                        Open in new tab ‚Üó
                      </a>
                      <span v-else class="text-xs text-purple-500 flex items-center gap-1">
                        &lt;/&gt; Embedded Code
                      </span>
                    </div>
                    <span class="text-3xl filter grayscale group-hover:grayscale-0 transition-all duration-300">
                      üëæ
                    </span>
                  </div>

                  <!-- Iframe container -->
                  <div
                    class="relative w-full bg-gray-200 dark:bg-black rounded-xl overflow-hidden shadow-inner border border-gray-300 dark:border-gray-700 mb-4 group-hover:ring-4 ring-pink-500/20 transition-all flex justify-center">
                    <div class="absolute inset-0 flex items-center justify-center text-gray-400 z-0">
                      <span class="animate-pulse">Loading Bad UI...</span>
                    </div>

                    <!-- Dynamic Iframe: Handles both URL and Code -->
                    <iframe v-if="site.type === 'url'" :src="site.url"
                      class="relative z-10 w-full max-w-[500px] h-[350px] bg-white" scrolling="auto" loading="lazy"
                      frameborder="0">
                    </iframe>
                    <iframe v-else :srcdoc="site.code" class="relative z-10 w-full max-w-[500px] h-[350px] bg-white"
                      scrolling="auto" loading="lazy" frameborder="0">
                    </iframe>
                  </div>

                  <!-- ACTION BAR (Score hidden as requested) -->
                  <div class="mt-auto flex items-center justify-center bg-gray-100 dark:bg-gray-800 p-3 rounded-2xl">
                    <button :disabled="competitionEnded || hasVoted(site.id)" @click="vote(site.id, $event)" :class="[
                        competitionEnded || hasVoted(site.id) ? 'bg-gray-400 cursor-not-allowed' : 'bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 hover:scale-105',
                        hasVoted(site.id) ? '!bg-green-500 !from-green-500 !to-green-600' : ''
                      ]"
                      class="w-full text-white px-6 py-3 rounded-xl shadow-lg transform active:scale-95 transition-all font-bold flex justify-center items-center gap-2 group/btn">
                      <span>{{ hasVoted(site.id) ? '‚úÖ Voted' : (competitionEnded ? 'Closed üîí' : 'üëç Vote') }}</span>
                      <span v-if="!competitionEnded && !hasVoted(site.id)"
                        class="group-hover/btn:animate-bounce">üî•</span>
                    </button>
                    <!-- SCORE HIDDEN FROM PUBLIC VIEW -->
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- SUBMIT PAGE -->
          <section v-else-if="currentPage === 'submit'" class="max-w-2xl mx-auto">

            <!-- Check if competition is ended -->
            <div v-if="competitionEnded"
              class="bg-white/90 dark:bg-gray-900/90 p-10 rounded-3xl shadow-2xl text-center">
              <h2 class="text-4xl font-black text-gray-400 mb-4">‚õî Submissions Closed</h2>
              <p class="text-xl">The deadline has passed! Good luck to all participants.</p>
              <button @click="goHome" class="mt-6 bg-blue-500 text-white px-6 py-2 rounded-xl">Back to Home</button>
            </div>

            <div v-else
              class="bg-white/90 dark:bg-gray-900/90 backdrop-blur-xl p-8 rounded-3xl shadow-2xl border-t-4 border-blue-500 relative overflow-hidden">
              <!-- Decorative background element -->
              <div class="absolute -top-10 -right-10 w-32 h-32 bg-blue-400/20 rounded-full blur-3xl"></div>

              <h2 class="text-3xl md:text-4xl font-black text-center mb-2 text-gray-800 dark:text-white relative z-10">
                Submit Entry üöÄ
              </h2>
              <p class="text-center text-gray-600 dark:text-gray-400 mb-8 relative z-10">
                All fields are mandatory. Show us what you got!
              </p>

              <!-- Submission Mode Toggle -->
              <div class="flex justify-center mb-6 relative z-10">
                <div class="bg-gray-200 dark:bg-gray-800 p-1 rounded-xl flex gap-1">
                  <button @click="submitMode = 'url'"
                    :class="submitMode === 'url' ? 'bg-white dark:bg-gray-700 shadow-sm text-blue-600 dark:text-blue-400' : 'text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'"
                    class="px-4 py-2 rounded-lg font-bold transition-all text-sm flex items-center gap-2">
                    üîó External Link
                  </button>
                  <button @click="submitMode = 'code'"
                    :class="submitMode === 'code' ? 'bg-white dark:bg-gray-700 shadow-sm text-purple-600 dark:text-purple-400' : 'text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'"
                    class="px-4 py-2 rounded-lg font-bold transition-all text-sm flex items-center gap-2">
                    üíª Paste Code
                  </button>
                </div>
              </div>

              <form @submit.prevent="submitSite" class="flex flex-col gap-6 relative z-10">
                
                <div class="grid grid-cols-2 gap-4">
                  <div class="group">
                    <label class="block text-sm font-bold mb-1 text-gray-700 dark:text-gray-300">First Name <span class="text-red-500">*</span></label>
                    <input v-model="form.firstName" placeholder="John"
                      class="w-full border-2 border-gray-200 dark:border-gray-700 p-3 rounded-xl dark:bg-gray-800 focus:border-blue-500 focus:outline-none transition-all"
                      required />
                  </div>
                  <div class="group">
                    <label class="block text-sm font-bold mb-1 text-gray-700 dark:text-gray-300">Last Name <span class="text-red-500">*</span></label>
                    <input v-model="form.lastName" placeholder="Doe"
                      class="w-full border-2 border-gray-200 dark:border-gray-700 p-3 rounded-xl dark:bg-gray-800 focus:border-blue-500 focus:outline-none transition-all"
                      required />
                  </div>
                </div>

                <div class="group">
                  <label class="block text-sm font-bold mb-1 text-gray-700 dark:text-gray-300">Email Address <span class="text-red-500">*</span></label>
                  <input type="email" v-model="form.email" placeholder="john.doe@example.com"
                    class="w-full border-2 border-gray-200 dark:border-gray-700 p-3 rounded-xl dark:bg-gray-800 focus:border-blue-500 focus:outline-none transition-all"
                    required />
                </div>

                <div class="group">
                  <label class="block text-sm font-bold mb-1 text-gray-700 dark:text-gray-300">Widget Title <span class="text-red-500">*</span></label>
                  <input v-model="form.title" placeholder="e.g. The Impossible Slider"
                    class="w-full border-2 border-gray-200 dark:border-gray-700 p-3 rounded-xl dark:bg-gray-800 focus:border-blue-500 focus:outline-none transition-all"
                    required />
                </div>

                <!-- URL Input -->
                <div v-if="submitMode === 'url'">
                  <label class="block text-sm font-bold mb-1 text-gray-700 dark:text-gray-300">GitHub Pages URL <span class="text-red-500">*</span></label>
                  <input v-model="form.url" placeholder="https://yourname.github.io/bad-ui-widget"
                    class="w-full border-2 border-gray-200 dark:border-gray-700 p-3 rounded-xl dark:bg-gray-800 focus:border-blue-500 focus:outline-none transition-all font-mono text-sm"
                    required />
                </div>

                <!-- Code Input -->
                <div v-if="submitMode === 'code'">
                  <label class="block text-sm font-bold mb-1 text-gray-700 dark:text-gray-300">Paste Your Code
                    (HTML/CSS/JS) <span class="text-red-500">*</span></label>
                  <textarea v-model="form.code" rows="8"
                    placeholder="<!DOCTYPE html><html><body><button>Click Me</button></body></html>"
                    class="w-full border-2 border-gray-200 dark:border-gray-700 p-3 rounded-xl dark:bg-gray-800 focus:border-purple-500 focus:outline-none transition-all font-mono text-xs"
                    required></textarea>
                </div>

                <button
                  class="relative overflow-hidden bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white p-4 rounded-xl shadow-lg shadow-blue-500/30 font-bold text-lg transform hover:-translate-y-1 transition-all flex justify-center items-center gap-2 group">

                  <!-- Shimmer Effect -->
                  <div
                    class="absolute inset-0 -translate-x-full group-hover:animate-[shimmer_1.5s_infinite] bg-gradient-to-r from-transparent via-white/20 to-transparent z-0">
                  </div>

                  <span class="relative z-10">Submit to the Chaos</span> <span class="relative z-10">üì§</span>
                </button>
              </form>

              <!-- Preview -->
              <div v-if="previewContent" class="mt-8">
                <div class="flex items-center gap-2 mb-2">
                  <span class="animate-pulse text-green-500">‚óè</span>
                  <h3 class="font-bold">Live Preview</h3>
                </div>
                <div class="flex justify-center bg-gray-800 p-4 rounded-2xl">
                  <iframe v-if="submitMode === 'url'" :src="previewContent" width="500" height="350"
                    class="bg-white rounded-lg shadow-lg" scrolling="auto">
                  </iframe>
                  <iframe v-else :srcdoc="previewContent" width="500" height="350" class="bg-white rounded-lg shadow-lg"
                    scrolling="auto">
                  </iframe>
                </div>
              </div>
            </div>
          </section>

          <!-- ADMIN DASHBOARD (Combined Leaderboard + Management) -->
          <section v-else-if="currentPage === 'admin'" class="max-w-6xl mx-auto">
            <div v-if="!adminAuth"
              class="max-w-md mx-auto bg-white/90 dark:bg-gray-900/90 p-8 rounded-3xl shadow-xl text-center">
              <div class="text-5xl mb-4">üîê</div>
              <h2 class="text-2xl font-bold mb-4">Admin Dashboard</h2>
              <form @submit.prevent="loginAdmin" class="flex gap-2">
                <input v-model="adminPass" type="password" placeholder="Password..."
                  class="flex-1 border p-3 rounded-xl dark:bg-gray-800" />
                <button class="bg-purple-600 text-white px-6 rounded-xl font-bold hover:bg-purple-700">
                  Go
                </button>
              </form>
            </div>

            <div v-else>
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-purple-600 dark:text-purple-300 flex items-center gap-2">
                  üõ† Dashboard
                </h2>
                <div class="flex gap-4">
                  <button @click="setPage('home')" class="text-sm text-gray-500 hover:text-purple-500">Browse Sites</button>
                  <button @click="adminAuth = false; localStorage.removeItem('adminAuth')" class="text-sm text-red-500 hover:underline">Logout</button>
                </div>
              </div>

              <!-- STATS CARDS -->
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow border-l-4 border-blue-500">
                  <span class="block text-gray-500 text-xs uppercase">Total Submissions</span>
                  <span class="text-2xl font-bold">{{ websites.length }}</span>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow border-l-4 border-green-500">
                  <span class="block text-gray-500 text-xs uppercase">Unique Participants</span>
                  <span class="text-2xl font-bold">{{ uniqueUsers.length }}</span>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow border-l-4 border-yellow-500">
                  <span class="block text-gray-500 text-xs uppercase">Top Vote</span>
                  <span class="text-2xl font-bold">{{ websites.length > 0 ? Math.max(...websites.map(s => s.votes||0)) : 0 }}</span>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow border-l-4 border-purple-500">
                  <span class="block text-gray-500 text-xs uppercase">Days Left</span>
                  <span class="text-2xl font-bold">{{ countdownString.split(' ')[0] }}</span>
                </div>
              </div>

              <!-- LEADERBOARD SECTION -->
              <div class="bg-white/90 dark:bg-gray-900/90 rounded-3xl shadow-xl overflow-hidden border border-gray-200 dark:border-gray-700 mb-8">
                <div class="p-6 border-b border-gray-100 dark:border-gray-800 bg-purple-50 dark:bg-purple-900/20">
                  <h3 class="font-bold text-xl text-purple-700 dark:text-purple-300">üèÜ Official Standings (All Unique Users)</h3>
                </div>
                
                <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
                  <!-- Full Leaderboard List -->
                  <div>
                    <h4 class="font-bold mb-4 text-gray-500 uppercase text-xs">Winners (Highest to Lowest)</h4>
                    <ul class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
                      <li v-for="(site, i) in uniqueLeaderboard" :key="site.id" class="flex items-center gap-4 bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="w-10 h-10 flex items-center justify-center rounded-full font-bold shadow-md"
                             :class="i===0 ? 'bg-yellow-400 text-white' : i===1 ? 'bg-gray-400 text-white' : i===2 ? 'bg-orange-400 text-white' : 'bg-gray-200 text-gray-600'">
                             {{ i + 1 }}
                        </div>
                        <div class="flex-1">
                          <p class="font-bold truncate">{{ site.title }}</p>
                          <p class="text-xs text-gray-500">{{ site.firstName }} {{ site.lastName }}</p>
                        </div>
                        <div class="font-mono font-bold text-xl">{{ site.votes }}</div>
                      </li>
                      <li v-if="uniqueLeaderboard.length === 0" class="text-gray-400 italic text-sm">Waiting for votes...</li>
                    </ul>
                  </div>

                  <!-- 4th and 5th Selectors -->
                  <div class="bg-gray-50 dark:bg-gray-800/50 p-6 rounded-xl border border-dashed border-gray-300 dark:border-gray-700">
                    <h4 class="font-bold mb-4 text-gray-500 uppercase text-xs">Honorable Mentions (Auto-Adjust Votes)</h4>
                    
                    <div class="mb-4">
                      <label class="block text-sm font-bold mb-1">4th Place Selection</label>
                      <select class="w-full p-2 rounded-lg border dark:bg-gray-800 text-sm" @change="setHonorable(4, $event.target.value)">
                        <option value="">-- Select Site --</option>
                        <option v-for="site in websites" :key="site.id" :value="site.id">
                          {{ site.title }} ({{site.firstName}} {{site.lastName}}) - Currently: {{site.votes}}
                        </option>
                      </select>
                      <p class="text-xs text-gray-400 mt-1">Selecting sets votes to: {{ uniqueLeaderboard.length >= 3 ? uniqueLeaderboard[2].votes - 1 : 'N/A' }}</p>
                    </div>

                    <div>
                      <label class="block text-sm font-bold mb-1">5th Place Selection</label>
                      <select class="w-full p-2 rounded-lg border dark:bg-gray-800 text-sm" @change="setHonorable(5, $event.target.value)">
                        <option value="">-- Select Site --</option>
                        <option v-for="site in websites" :key="site.id" :value="site.id">
                          {{ site.title }} ({{site.firstName}} {{site.lastName}}) - Currently: {{site.votes}}
                        </option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <!-- DATA MANAGEMENT TABLE -->
              <div class="bg-white/90 dark:bg-gray-900/90 rounded-3xl shadow-xl overflow-hidden border border-gray-200 dark:border-gray-700">
                <div class="p-6 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
                  <h3 class="font-bold text-lg">Submission Management (Ranked)</h3>
                </div>
                <div class="overflow-x-auto">
                  <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 dark:bg-gray-800 text-gray-500 uppercase text-xs">
                      <tr>
                        <th class="px-6 py-3">User</th>
                        <th class="px-6 py-3">Email</th>
                        <th class="px-6 py-3">Title</th>
                        <th class="px-6 py-3">Votes</th>
                        <th class="px-6 py-3">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Using sortedWinners instead of websites to show ranked list -->
                      <tr v-for="site in sortedWinners" :key="site.id" class="border-b border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50">
                        
                        <!-- EDIT MODE -->
                        <template v-if="editingId === site.id">
                          <td class="px-6 py-4">
                            <input v-model="editForm.firstName" class="border p-1 rounded w-20 text-xs dark:bg-gray-700" placeholder="First">
                            <input v-model="editForm.lastName" class="border p-1 rounded w-20 text-xs dark:bg-gray-700" placeholder="Last">
                          </td>
                          <td class="px-6 py-4">
                            <input v-model="editForm.email" class="border p-1 rounded w-full text-xs dark:bg-gray-700">
                          </td>
                          <td class="px-6 py-4">
                            <span class="text-xs text-gray-400">{{ site.title }}</span>
                          </td>
                          <td class="px-6 py-4">
                            <input type="number" v-model.number="editForm.votes" class="border p-1 rounded w-16 text-xs dark:bg-gray-700">
                          </td>
                          <td class="px-6 py-4 flex gap-2">
                            <button @click="saveEdit(site.id)" class="text-green-600 font-bold hover:underline">Save</button>
                            <button @click="editingId = null" class="text-gray-500 hover:underline">Cancel</button>
                          </td>
                        </template>

                        <!-- VIEW MODE -->
                        <template v-else>
                          <td class="px-6 py-4 font-bold">{{ site.firstName }} {{ site.lastName }}</td>
                          <td class="px-6 py-4 text-gray-500">{{ site.email }}</td>
                          <td class="px-6 py-4 truncate max-w-xs">{{ site.title }}</td>
                          <td class="px-6 py-4 font-mono font-bold">{{ site.votes || 0 }}</td>
                          <td class="px-6 py-4 flex gap-3">
                            <button @click="startEdit(site)" class="text-blue-500 hover:text-blue-700 font-bold">Edit</button>
                            <button @click="deleteEntry(site.id)" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                          </td>
                        </template>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

            </div>
          </section>

        </div>
      </transition>
    </main>

    <!-- Footer -->
    <footer class="text-center p-6 text-sm text-gray-500 bg-white/30 dark:bg-black/30 backdrop-blur-sm">
      <p>ConnX Holiday Competition 2025 ‚Ä¢ "Rate Your Ride"</p>
    </footer>

  </div>

  <!-- FIREBASE + APP SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      updateDoc,
      deleteDoc,
      doc,
      increment,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    // UPDATED FIREBASE KEYS FROM YOUR SCREENSHOT
    const firebaseConfig = {
      apiKey: "AIzaSyDlR4QxTG6EGwkHXJgQE-_WS-33cs9ytZY",
      authDomain: "website-competition-fd59e.firebaseapp.com",
      projectId: "website-competition-fd59e",
      storageBucket: "website-competition-fd59e.firebasestorage.app",
      messagingSenderId: "558845407480",
      appId: "1:558845407480:web:cef69f716712998e524b0d",
      measurementId: "G-3344P4ZNVE"
    };

    const appFB = initializeApp(firebaseConfig);
    const db = getFirestore(appFB);
    const colRef = collection(db, "websites");

    // --- Snow / Confetti Logic ---
    const snowCanvas = document.getElementById("snowCanvas");
    const ctx = snowCanvas.getContext("2d");

    function resizeCanvas() {
      snowCanvas.width = window.innerWidth;
      snowCanvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    let snowEnabled = true;
    const particles = [];

    function initParticles() {
      particles.length = 0;
      const count = window.innerWidth < 600 ? 40 : 100;
      for (let i = 0; i < count; i++) {
        const typeRand = Math.random();
        let type = "snow";
        if (typeRand > 0.8) type = "confetti";

        particles.push({
          x: Math.random() * snowCanvas.width,
          y: Math.random() * snowCanvas.height,
          r: Math.random() * 3 + 1,
          d: Math.random() * 1 + 0.5,
          type,
          color: `hsl(${Math.random() * 360}, 80%, 60%)`,
          tilt: Math.random() * 10,
          tiltAngle: 0,
          tiltAngleIncremental: (Math.random() * 0.07) + 0.05
        });
      }
    }
    initParticles();

    function drawParticles() {
      ctx.clearRect(0, 0, snowCanvas.width, snowCanvas.height);
      if (!snowEnabled) return;

      particles.forEach(p => {
        ctx.beginPath();
        if (p.type === "snow") {
          ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
          ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
          ctx.fill();
        } else {
          ctx.fillStyle = p.color;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.tilt);
          ctx.fillRect(-p.r, -p.r, p.r * 2, p.r * 2);
          ctx.restore();
        }
      });
    }

    function updateParticles() {
      if (!snowEnabled) return;
      particles.forEach(p => {
        p.tiltAngle += p.tiltAngleIncremental;
        p.y += (Math.cos(p.d) + 1 + p.r / 2) * 0.5;
        p.tilt = Math.sin(p.tiltAngle) * 15;

        if (p.y > snowCanvas.height) {
          p.y = -10;
          p.x = Math.random() * snowCanvas.width;
        }
      });
    }

    function animateBackground() {
      drawParticles();
      updateParticles();
      requestAnimationFrame(animateBackground);
    }
    animateBackground();

    // --- Vue App ---
    const { createApp } = Vue;

    const voteSound = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
    const submitSound = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
    const tadaSound = new Audio("https://actions.google.com/sounds/v1/cartoon/tada_fanfare_a.ogg");

    createApp({
      data() {
        return {
          currentPage: "home",
          websites: [],
          submitMode: "url", // 'url' or 'code'
          // UPDATED FORM DATA
          form: { firstName: "", lastName: "", email: "", title: "", url: "", code: "" },
          
          adminAuth: localStorage.getItem('adminAuth') === 'true',
          adminPass: "",
          
          // ADMIN EDITING STATE
          editingId: null,
          editForm: {},

          snowEnabled: true,
          isDark: false,
          chaosMode: false,
          countdownString: "Calculating...",
          competitionEnded: false,
          timerInterval: null,
          votedItems: [], // Track votes in local state
          processingVotes: new Set() // Prevent multiple clicks on same item
        };
      },

      computed: {
        // Returns ALL websites sorted by vote
        sortedWinners() {
          return [...this.websites].sort((a, b) => (b.votes ?? 0) - (a.votes ?? 0));
        },
        
        // Returns Unique Users for Top 3 (Based on Email)
        uniqueLeaderboard() {
            const sorted = this.sortedWinners;
            const unique = [];
            const seenEmails = new Set();
            
            for (const site of sorted) {
                // REMOVED THE LIMIT OF 3
                if (site.email && !seenEmails.has(site.email)) {
                    unique.push(site);
                    seenEmails.add(site.email);
                }
            }
            return unique;
        },

        // Returns List of Unique Users total
        uniqueUsers() {
            const emails = this.websites.map(s => s.email).filter(Boolean);
            return [...new Set(emails)];
        },

        previewContent() {
          if (this.submitMode === 'url') {
            return (this.form.url && this.form.url.startsWith("https://")) ? this.form.url : "";
          } else {
            return this.form.code;
          }
        }
      },

      methods: {
        handleRoute() {
          const route = location.hash.replace("#/", "") || "home";
          this.currentPage = route;
        },

        navigate(event) {
          const value = event.target.value;
          location.hash = "#/" + value;
          this.currentPage = value;
        },

        goHome() {
          location.hash = "#/home";
        },

        setPage(page) {
          this.currentPage = page;
          window.location.hash = '#/' + page;
        },

        toggleDark() {
          this.isDark = !this.isDark;
          document.documentElement.classList.toggle("dark");
        },

        toggleSnow() {
          this.snowEnabled = !this.snowEnabled;
          snowEnabled = this.snowEnabled;
        },

        toggleChaos() {
          this.chaosMode = !this.chaosMode;
          if (this.chaosMode) {
            submitSound.play();
            confetti({
              particleCount: 50,
              spread: 100,
              origin: { y: 0.6 },
              colors: ['#000000', '#FF0000']
            });
          }
        },

        hasVoted(id) {
          return this.votedItems.includes(id);
        },

        async submitSite() {
          if (this.competitionEnded) {
            alert("Submissions are closed!");
            return;
          }

          // Validation
          if (!this.form.firstName || !this.form.lastName || !this.form.email || !this.form.title) {
            alert("All fields marked with * are mandatory!");
            return;
          }

          if (this.submitMode === 'url' && !this.form.url.startsWith("https://")) {
            alert("URL must start with https://");
            return;
          }
          if (this.submitMode === 'code' && !this.form.code.trim()) {
            alert("Please paste some code!");
            return;
          }

          try {
            const payload = {
              firstName: this.form.firstName.trim(),
              lastName: this.form.lastName.trim(),
              email: this.form.email.trim(),
              title: this.form.title.trim(),
              type: this.submitMode, // 'url' or 'code'
              votes: 0,
              submittedAt: new Date()
            };

            if (this.submitMode === 'url') {
              payload.url = this.form.url.trim();
            } else {
              payload.code = this.form.code;
            }

            await addDoc(colRef, payload);

            submitSound.currentTime = 0;
            submitSound.play();
            alert("Entry submitted! Good luck!");
            // Reset Form
            this.form = { firstName: "", lastName: "", email: "", title: "", url: "", code: "" };
            this.goHome();
          } catch (e) {
            console.error(e);
            alert("Error submitting entry.");
          }
        },

        async vote(id, event) {
          if (this.competitionEnded) {
            alert("Voting is closed!");
            return;
          }

          if (this.processingVotes.has(id)) return;

          const voted = JSON.parse(localStorage.getItem("voted") || "[]");
          if (voted.includes(id)) {
            alert("You've already voted for this masterpiece! üö´");
            this.votedItems = voted;
            return;
          }

          this.processingVotes.add(id);

          try {
            this.votedItems.push(id);
            voted.push(id);
            localStorage.setItem("voted", JSON.stringify(voted));

            voteSound.currentTime = 0;
            voteSound.play();

            const rect = event.target.getBoundingClientRect();
            const x = (rect.left + rect.width / 2) / window.innerWidth;
            const y = (rect.top + rect.height / 2) / window.innerHeight;

            confetti({
              particleCount: 100,
              spread: 70,
              origin: { x, y },
              shapes: ['circle', 'square'],
              colors: ['#FFC0CB', '#FFD700', '#00FFFF'],
              disableForReducedMotion: true
            });

            const ref = doc(db, "websites", id);
            await updateDoc(ref, { votes: increment(1) });

          } catch (e) {
            console.error(e);
            alert("Error casting vote. Try again!");
            this.votedItems = this.votedItems.filter(v => v !== id);
            const newVoted = JSON.parse(localStorage.getItem("voted") || "[]").filter(v => v !== id);
            localStorage.setItem("voted", JSON.stringify(newVoted));
          } finally {
            this.processingVotes.delete(id);
          }
        },

        // --- ADMIN FUNCTIONS ---
        loginAdmin() {
          if (this.adminPass === "connx2025") {
            this.adminAuth = true;
            localStorage.setItem('adminAuth', 'true');
            tadaSound.play();
          } else {
            alert("Wrong password. Nice try hacker! üïµÔ∏è‚Äç‚ôÇÔ∏è");
          }
        },

        async deleteEntry(id) {
          if (!confirm("Are you sure? This action is permanent.")) return;
          try {
            await deleteDoc(doc(db, "websites", id));
          } catch (e) {
            alert("Error deleting.");
          }
        },

        startEdit(site) {
          this.editingId = site.id;
          this.editForm = { ...site };
        },

        async saveEdit(id) {
          try {
            const ref = doc(db, "websites", id);
            await updateDoc(ref, {
              firstName: this.editForm.firstName,
              lastName: this.editForm.lastName,
              email: this.editForm.email,
              votes: parseInt(this.editForm.votes)
            });
            this.editingId = null;
            alert("Updated successfully");
          } catch(e) {
            alert("Error updating");
          }
        },

        async setHonorable(rank, siteId) {
            if (!siteId) return;
            // Logic: 
            // 4th Place Vote = (3rd Place Vote) - 1
            // 5th Place Vote = (4th Place Vote) - 1
            // Note: This forces the order in the sorted list.
            
            const sorted = this.sortedWinners;
            let targetVotes = 0;

            if (rank === 4) {
               // Get vote count of 3rd place (index 2) from Unique List if possible, else raw list
               // User wants "Top of 4" based on Unique Top 3.
               const thirdPlace = this.uniqueLeaderboard[2];
               if (thirdPlace) {
                 targetVotes = Math.max(0, thirdPlace.votes - 1);
               } else if (sorted.length > 0) {
                 // Fallback if less than 3 unique users
                 targetVotes = Math.max(0, sorted[sorted.length-1].votes - 1); 
               }
            } else if (rank === 5) {
               // We need the CURRENT 4th place votes.
               // Since we might have just updated 4th, we should ideally wait or calc dynamically.
               // For simplicity: Find the site at index 3 (4th place) in sorted list
               const fourthPlace = sorted[3]; 
               if (fourthPlace) {
                   targetVotes = Math.max(0, fourthPlace.votes - 1);
               }
            }

            if (confirm(`Set rank ${rank} for this site? This will update its votes to ${targetVotes}.`)) {
                const ref = doc(db, "websites", siteId);
                await updateDoc(ref, { votes: targetVotes });
            }
        },

        updateCountdown() {
          const targetDate = new Date("December 11, 2025 15:00:00 EST").getTime();
          const now = new Date().getTime();
          const distance = targetDate - now;

          if (distance < 0) {
            this.countdownString = "Winners Announced! üéâ";
            this.competitionEnded = true; 
            return;
          } else {
            this.competitionEnded = false;
          }

          const days = Math.floor(distance / (1000 * 60 * 60 * 24));
          const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

          this.countdownString = `${days}d ${hours}h ${minutes}m`;
        }
      },

      mounted() {
        window.addEventListener("hashchange", this.handleRoute);
        this.handleRoute();

        // Load initial voted state
        this.votedItems = JSON.parse(localStorage.getItem("voted") || "[]");

        onSnapshot(colRef, (snapshot) => {
          this.websites = snapshot.docs.map(d => ({
            id: d.id,
            ...d.data()
          }));
        });

        this.updateCountdown();
        this.timerInterval = setInterval(this.updateCountdown, 1000); 

        // Konami Code
        let kKeys = [];
        const konami = "38,38,40,40,37,39,37,39,66,65";
        document.addEventListener("keydown", (e) => {
          kKeys.push(e.keyCode);
          if (kKeys.toString().indexOf(konami) >= 0) {
            kKeys = [];
            tadaSound.play();
            alert("üåü KONAMI CODE ACTIVATED! YOU ARE A LEGEND! üåü");
          }
        });
      },

      unmounted() {
        if (this.timerInterval) clearInterval(this.timerInterval);
      }
    }).mount("#app");
  </script>
</body>

</html>
